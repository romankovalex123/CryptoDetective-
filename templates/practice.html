{% extends "base.html" %}

{% block title %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è: ECDH –∏ ECDSA{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 60px;">
    <h1>üß™ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</h1>
    <p style="font-size: 1.3rem; color: #aaa;">
        –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –∫—Ä–∏–≤—ã—Ö –∏ —Å–∏–º—É–ª—è—Ü–∏–∏ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤.
    </p>
</div>

<!-- ------------------ –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –•–û–õ–°–¢ (–í–û–ó–í–†–ê–¢) ------------------ -->
<div class="card" style="border-left-color: var(--accent-flower);">
    <h2>1. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –•–æ–ª—Å—Ç: –°–ª–æ–∂–µ–Ω–∏–µ –¢–æ—á–µ–∫ (P + Q)</h2>
    <p>–ò–∑—É—á–∏—Ç–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫—É—é –æ–ø–µ—Ä–∞—Ü–∏—é —Å–ª–æ–∂–µ–Ω–∏—è —Ç–æ—á–µ–∫ –Ω–∞ —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–æ–π –∫—Ä–∏–≤–æ–π. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ –≤—Å–µ–≥–æ ECC.</p>
    <div class="math-block" style="margin-top: 10px;">
        $$ y^2 = x^3 + ax + b $$
    </div>

    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
        <div style="flex: 1;">
            <label style="color: var(--accent-flower);">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç a: <span id="valA"></span></label>
            <input type="range" id="paramA" min="-5" max="5" step="0.5" value="-2" style="width: 100%;">
        </div>
        <div style="flex: 1;">
            <label style="color: var(--accent-flower);">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç b: <span id="valB"></span></label>
            <input type="range" id="paramB" min="-5" max="5" step="0.5" value="2" style="width: 100%;">
        </div>
    </div>

    <canvas id="eccCanvas" width="800" height="500" style="width: 100%; border: 1px solid #555; background: #fff; cursor: crosshair;"></canvas>

    <div class="interactive-panel">
        <p id="statusMsg" style="color: var(--highlight);">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–∏–≤—É—é, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É P. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏ Q.</p>
        <div style="margin-top: 10px; font-family: monospace;">
            P: <span id="pointP" style="color: var(--accent-flower);">(?, ?)</span> |
            Q: <span id="pointQ" style="color: var(--accent-leaf);">(?, ?)</span> |
            R (P+Q): <span id="pointR" style="color: #F44336;">(?, ?)</span>
        </div>
        <button onclick="resetCanvas()" class="btn" style="background: var(--error); margin-top: 10px;">–°–±—Ä–æ—Å</button>
    </div>
</div>

<!-- ------------------ –°–ò–ú–£–õ–Ø–¢–û–† ECDH ------------------ -->
<div class="card" style="border-left-color: var(--accent-leaf);">
    <h2>2. ECDH: –û–±–º–µ–Ω –ö–ª—é—á–∞–º–∏ –î–∏—Ñ—Ñ–∏-–•–µ–ª–ª–º–∞–Ω–∞ –Ω–∞ –≠–ö</h2>
    <p>–ü—Ä–æ—Ç–æ–∫–æ–ª, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –ê–ª–∏—Å–µ –∏ –ë–æ–±—É —Å–æ–∑–¥–∞—Ç—å –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –ø–æ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –∫–∞–Ω–∞–ª—É.</p>
    <div class="math-block">
        $$\text{–û–±—â–∏–π –∫–ª—é—á} = \text{–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –ê–ª–∏—Å—ã} \cdot \text{–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ë–æ–±–∞}$$
        $$\text{–û–±—â–∏–π –∫–ª—é—á} = \text{–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –ë–æ–±–∞} \cdot \text{–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ê–ª–∏—Å—ã}$$
    </div>
    <p style="color: var(--accent-flower);">* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è –∫—Ä–∏–≤–∞—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏: $y^2 = x^3 + 2x + 1 \pmod{17}$. –ë–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞ $G(5, 1)$</p>

    <div class="interactive-panel">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- –ê–ª–∏—Å–∞ -->
            <div>
                <h3>–ê–ª–∏—Å–∞ (Alice)</h3>
                <div class="input-group">
                    <label for="alicePrivate">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á $d_A$ (—á–∏—Å–ª–æ 1..16):</label>
                    <input type="number" id="alicePrivate" value="10" min="1" max="16">
                    <button onclick="generateKeys('A')" class="btn" style="background: var(--accent-flower);">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
                </div>
                <div class="result-box" id="alicePublic">–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_A$:</div>
            </div>
            <!-- –ë–æ–± -->
            <div>
                <h3>–ë–æ–± (Bob)</h3>
                <div class="input-group">
                    <label for="bobPrivate">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á $d_B$ (—á–∏—Å–ª–æ 1..16):</label>
                    <input type="number" id="bobPrivate" value="7" min="1" max="16">
                    <button onclick="generateKeys('B')" class="btn" style="background: var(--accent-flower);">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
                </div>
                <div class="result-box" id="bobPublic">–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_B$:</div>
            </div>
        </div>

        <button onclick="calculateSharedSecret()" class="btn" style="width: 100%; margin-top: 20px; background: var(--success);">
            4. –í—ã—á–∏—Å–ª–∏—Ç—å –û–±—â–∏–π –°–µ–∫—Ä–µ—Ç (K)
        </button>
        <div class="result-box success" id="sharedSecret"></div>
    </div>
</div>

<!-- ------------------ –°–ò–ú–£–õ–Ø–¢–û–† ECDSA ------------------ -->
<div class="card" style="border-left-color: var(--highlight);">
    <h2>3. ECDSA: –¶–∏—Ñ—Ä–æ–≤–∞—è –ü–æ–¥–ø–∏—Å—å</h2>
    <p>–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—â–µ–µ –µ–≥–æ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å.</p>

    <div class="interactive-panel">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ (–ê–ª–∏—Å–∞) -->
            <div>
                <h3>–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ (–ê–ª–∏—Å–∞)</h3>
                <div class="input-group">
                    <label for="ecdsaPrivate">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á $d_A$ (1..16):</label>
                    <input type="number" id="ecdsaPrivate" value="10" min="1" max="16">
                    <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ (Message):</label>
                    <textarea id="message" rows="2">–¢–∞–π–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –¥–ª—è –ë–æ–±–∞.</textarea>
                    <button onclick="generateSignature()" class="btn" style="background: var(--accent-flower);">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å—å (r, s)</button>
                </div>
                <div class="result-box" id="signatureResult"></div>
            </div>
            <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ (–ë–æ–±) -->
            <div>
                <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ (–ë–æ–±)</h3>
                <div class="input-group">
                    <label for="ecdsaPublic">–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_A$ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏):</label>
                    <input type="text" id="ecdsaPublic" placeholder="PA(x, y)" disabled>
                    <label for="verifyR">r (–ü–æ–¥–ø–∏—Å—å R):</label>
                    <input type="text" id="verifyR" placeholder="r">
                    <label for="verifyS">s (–ü–æ–¥–ø–∏—Å—å S):</label>
                    <input type="text" id="verifyS" placeholder="s">
                    <button onclick="verifySignature()" class="btn" style="background: var(--accent-leaf);">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å</button>
                </div>
                <div class="result-box" id="verificationResult"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ECC –•–æ–ª—Å—Ç –§–£–ù–ö–¶–ò–ò (–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–ª–æ–∂–µ–Ω–∏–µ —Ç–æ—á–µ–∫) ---
    const canvas = document.getElementById('eccCanvas');
    const ctx = canvas.getContext('2d');
    const SCALE = 30; // 1 unit = 30 pixels
    let A = -2, B = 2;
    let pointP = null;
    let pointQ = null;

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ö–æ–ª—Å—Ç–∞
    function toCanvas(x, y) {
        return {
            x: canvas.width / 2 + x * SCALE,
            y: canvas.height / 2 - y * SCALE
        };
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ö–æ–ª—Å—Ç–∞ –≤ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    function toMath(cx, cy) {
        return {
            x: (cx - canvas.width / 2) / SCALE,
            y: (canvas.height / 2 - cy) / SCALE
        };
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏
    function drawPoint(point, color, label) {
        if (!point) return;
        const c = toCanvas(point.x, point.y);
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(c.x, c.y, 5, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = '#111';
        ctx.font = '14px sans-serif';
        ctx.fillText(label, c.x + 8, c.y - 8);
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏
    function drawLine(p1, p2, color, thickness = 1) {
        if (!p1 || !p2) return;
        const c1 = toCanvas(p1.x, p1.y);
        const c2 = toCanvas(p2.x, p2.y);
        ctx.strokeStyle = color;
        ctx.lineWidth = thickness;
        ctx.beginPath();
        ctx.moveTo(c1.x, c1.y);
        ctx.lineTo(c2.x, c2.y);
        ctx.stroke();
    }

    // –ê–ª–≥–æ—Ä–∏—Ç–º —Å–ª–æ–∂–µ–Ω–∏—è P + Q = R (–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏)
    function calculateR(P, Q) {
        if (!P || !Q) return null;

        let m;
        if (P.x === Q.x && P.y === -Q.y) {
            // P + (-P) = O (–¢–æ—á–∫–∞ –Ω–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏)
            return { x: Infinity, y: Infinity };
        } else if (P.x === Q.x && P.y === Q.y) {
            // –£–¥–≤–æ–µ–Ω–∏–µ P (P + P)
            // m = (3x^2 + A) / 2y
            m = (3 * P.x * P.x + A) / (2 * P.y);
        } else {
            // –°–ª–æ–∂–µ–Ω–∏–µ P + Q
            // m = (yQ - yP) / (xQ - xP)
            m = (Q.y - P.y) / (Q.x - P.x);
        }

        // Rx = m^2 - Px - Qx
        const Rx = m * m - P.x - Q.x;
        // Ry = m(Px - Rx) - Py
        const Ry = m * (P.x - Rx) - P.y;

        // R - —ç—Ç–æ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è R' (Rx, -Ry)
        return { x: Rx, y: Ry };
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä–∏–≤–æ–π –∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function drawCurve() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –û—Å—å X, Y
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height);
        ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2);
        ctx.stroke();

        // –ö—Ä–∏–≤–∞—è (A, B)
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.beginPath();
        let first = true;
        for (let px = 0; px < canvas.width; px++) {
            let x = (px - canvas.width/2) / SCALE;
            let val = x*x*x + A*x + B;
            if (val >= 0) {
                let y = Math.sqrt(val);

                // –í–µ—Ä—Ö–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞
                let py1 = canvas.height/2 - y * SCALE;
                if (first) {
                    ctx.moveTo(px, py1);
                    first = false;
                } else {
                    ctx.lineTo(px, py1);
                }
            }
        }
        ctx.stroke();

        ctx.beginPath();
        first = true;
        for (let px = canvas.width - 1; px >= 0; px--) {
            let x = (px - canvas.width/2) / SCALE;
            let val = x*x*x + A*x + B;
            if (val >= 0) {
                let y = Math.sqrt(val);

                // –ù–∏–∂–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞
                let py2 = canvas.height/2 + y * SCALE;
                if (first) {
                    ctx.moveTo(px, py2);
                    first = false;
                } else {
                    ctx.lineTo(px, py2);
                }
            }
        }
        ctx.stroke();

        // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏ –∏ –ª–∏–Ω–∏—é —Å–ª–æ–∂–µ–Ω–∏—è
        if (pointP && pointQ) {
            const R_prime = calculateR(pointP, pointQ); // R' - —Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä—è–º–æ–π P-Q —Å –∫—Ä–∏–≤–æ–π (Rx, Ry)
            const R_sum = { x: R_prime.x, y: -R_prime.y }; // R = P+Q (–æ—Ç—Ä–∞–∂–µ–Ω–∏–µ R')

            // 1. –õ–∏–Ω–∏—è, —Å–æ–µ–¥–∏–Ω—è—é—â–∞—è P –∏ Q (–∏–ª–∏ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–∞—è –∫ P)
            drawLine(pointP, pointQ, '#000000', 1);

            // 2. –¢–æ—á–∫–∞ R' (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å –∫—Ä–∏–≤–æ–π)
            if (R_prime.x !== Infinity) {
                drawPoint(R_prime, '#F44336', 'R\'');
                // 3. –õ–∏–Ω–∏—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è (R' -> R)
                drawLine(R_prime, R_sum, '#555555', 1);
                // 4. –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ R = P+Q
                drawPoint(R_sum, '#F44336', 'P+Q');
            }

            document.getElementById('pointR').innerText = `(${R_sum.x.toFixed(2)}, ${R_sum.y.toFixed(2)})`;
            document.getElementById('statusMsg').innerText = `–°–ª–æ–∂–µ–Ω–∏–µ: P(${pointP.x.toFixed(2)}, ${pointP.y.toFixed(2)}) + Q(${pointQ.x.toFixed(2)}, ${pointQ.y.toFixed(2)}) = R(${R_sum.x.toFixed(2)}, ${R_sum.y.toFixed(2)})`;

        }

        drawPoint(pointP, 'var(--accent-flower)', 'P'); // –¢–æ—á–∫–∞ P (–§–∏–æ–ª–µ—Ç–æ–≤–∞—è)
        drawPoint(pointQ, 'var(--accent-leaf)', 'Q'); // –¢–æ—á–∫–∞ Q (–ó–µ–ª–µ–Ω–∞—è)
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Ö–æ–ª—Å—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫
    function handleInput(event) {
        const rect = canvas.getBoundingClientRect();
        const cx = event.clientX - rect.left;
        const cy = event.clientY - rect.top;
        const mathPoint = toMath(cx, cy);

        // –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π —Ç–æ—á–∫–∏ –Ω–∞ –∫—Ä–∏–≤–æ–π
        let bestPoint = null;
        let minDistance = Infinity;

        for (let x_test = -canvas.width/(2*SCALE); x_test <= canvas.width/(2*SCALE); x_test += 0.05) {
            let val = x_test*x_test*x_test + A*x_test + B;
            if (val >= 0) {
                let y1 = Math.sqrt(val);
                let y2 = -y1;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ö–Ω—é—é –∏ –Ω–∏–∂–Ω—é—é –ø–æ–ª–æ–≤–∏–Ω—É
                [[x_test, y1], [x_test, y2]].forEach(([x, y]) => {
                    const dist = Math.sqrt((x - mathPoint.x)**2 + (y - mathPoint.y)**2);
                    if (dist < minDistance && dist < 0.5) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ—á–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–ª–∏–∑–∫–æ
                        minDistance = dist;
                        bestPoint = {x: x, y: y};
                    }
                });
            }
        }

        if (bestPoint) {
            if (!pointP) {
                pointP = bestPoint;
                document.getElementById('pointP').innerText = `(${pointP.x.toFixed(2)}, ${pointP.y.toFixed(2)})`;
                document.getElementById('statusMsg').innerText = "–¢–æ—á–∫–∞ P –≤—ã–±—Ä–∞–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É Q.";
            } else if (!pointQ) {
                pointQ = bestPoint;
                document.getElementById('pointQ').innerText = `(${pointQ.x.toFixed(2)}, ${pointQ.y.toFixed(2)})`;
                document.getElementById('statusMsg').innerText = "–¢–æ—á–∫–∞ Q –≤—ã–±—Ä–∞–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç R = P + Q –ø–æ–∫–∞–∑–∞–Ω –∫—Ä–∞—Å–Ω—ã–º.";
            } else {
                resetCanvas();
                pointP = bestPoint;
                document.getElementById('pointP').innerText = `(${pointP.x.toFixed(2)}, ${pointP.y.toFixed(2)})`;
                document.getElementById('statusMsg').innerText = "–°–±—Ä–æ—à–µ–Ω–æ. –¢–æ—á–∫–∞ P –≤—ã–±—Ä–∞–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É Q.";
            }
            drawCurve();
        } else {
            document.getElementById('statusMsg').innerText = "–û—à–∏–±–∫–∞: –ù–∞–∂–º–∏—Ç–µ –±–ª–∏–∂–µ –∫ –∫—Ä–∏–≤–æ–π.";
        }
    }

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ö–æ–ª—Å—Ç–∞
    function resetCanvas() {
        pointP = null;
        pointQ = null;
        document.getElementById('pointP').innerText = '(?, ?)';
        document.getElementById('pointQ').innerText = '(?, ?)';
        document.getElementById('pointR').innerText = '(?, ?)';
        document.getElementById('statusMsg').innerText = "–°–±—Ä–æ—à–µ–Ω–æ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–∏–≤—É—é, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É P.";
        drawCurve();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö–æ–ª—Å—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
    document.getElementById('paramA').oninput = function() { A = parseFloat(this.value); document.getElementById('valA').innerText = A; resetCanvas(); };
    document.getElementById('paramB').oninput = function() { B = parseFloat(this.value); document.getElementById('valB').innerText = B; resetCanvas(); };
    canvas.addEventListener('click', handleInput);

    document.getElementById('valA').innerText = A;
    document.getElementById('valB').innerText = B;
    drawCurve();


    // --- ECDH/ECDSA –§–£–ù–ö–¶–ò–ò (–†–∞–±–æ—Ç–∞ –≤ –∫–æ–Ω–µ—á–Ω–æ–º –ø–æ–ª–µ GF(p)) ---

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–æ–≤–æ–π –∫—Ä–∏–≤–æ–π: Y^2 = X^3 + 2X + 1 (mod 17)
    const p = 17; // –ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª—è
    const G = { x: 5, y: 1 }; // –ë–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞
    const A_param = 2; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç A –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–π –∫—Ä–∏–≤–æ–π
    const B_param = 1; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç B –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–π –∫—Ä–∏–≤–æ–π

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∑—è—Ç–∏—è –æ—Å—Ç–∞—Ç–∫–∞ –ø–æ –º–æ–¥—É–ª—é
    function mod(n, m) {
        return ((n % m) + m) % m;
    }

    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ï–≤–∫–ª–∏–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (a^-1 mod p)
    function inverse(a, m) {
        if (a === 0) return 0;
        let m0 = m;
        let x0 = 0;
        let x1 = 1;
        a = mod(a, m);

        while (a > 1) {
            let q = Math.floor(m / a);
            let t = m % a;
            m = a;
            a = t;
            t = x0 - q * x1;
            x0 = x1;
            x1 = t;
        }
        return mod(x1, m0);
    }

    // –°–ª–æ–∂–µ–Ω–∏–µ —Ç–æ—á–µ–∫ P + Q (–ø–æ –º–æ–¥—É–ª—é p)
    function addPoints(P, Q) {
        if (P === null) return Q;
        if (Q === null) return P;

        let m;
        if (P.x === Q.x && mod(P.y + Q.y, p) === 0) {
            // P + (-P) = –¢–æ—á–∫–∞ –Ω–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏ (O)
            return null;
        } else if (P.x === Q.x && P.y === Q.y) {
            // –£–¥–≤–æ–µ–Ω–∏–µ P: m = (3x^2 + A) * (2y)^-1 mod p
            const numerator = mod(3 * P.x * P.x + A_param, p);
            const denominator = mod(2 * P.y, p);
            m = mod(numerator * inverse(denominator, p), p);
        } else {
            // P + Q: m = (yQ - yP) * (xQ - xP)^-1 mod p
            const numerator = mod(Q.y - P.y, p);
            const denominator = mod(Q.x - P.x, p);
            m = mod(numerator * inverse(denominator, p), p);
        }

        // Rx = m^2 - Px - Qx mod p
        const Rx = mod(m * m - P.x - Q.x, p);
        // Ry = m * (P.x - Rx) - P.y mod p
        const Ry = mod(m * (P.x - Rx) - P.y, p);

        return { x: Rx, y: Ry };
    }

    // –£–º–Ω–æ–∂–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –Ω–∞ —Å–∫–∞–ª—è—Ä: k * G (–∏—Å–ø–æ–ª—å–∑—É—è Double and Add)
    function multiplyPoint(k, P) {
        let result = null;
        let current = P;

        let i = k;
        while (i > 0) {
            if (mod(i, 2) === 1) {
                result = addPoints(result, current);
            }
            current = addPoints(current, current); // –£–¥–≤–æ–µ–Ω–∏–µ
            i = Math.floor(i / 2);
        }
        return result;
    }

    // --- ECDH –§–£–ù–ö–¶–ò–ò ---

    let P_A = null; // –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ê–ª–∏—Å—ã
    let P_B = null; // –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ë–æ–±–∞

    function displayPoint(point) {
        if (point) {
            return `(${point.x}, ${point.y})`;
        }
        return 'O (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)';
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ P = d * G
    function generateKeys(user) {
        const privateKeyInput = document.getElementById(user === 'A' ? 'alicePrivate' : 'bobPrivate');
        const publicKeyDiv = document.getElementById(user === 'A' ? 'alicePublic' : 'bobPublic');

        const d = parseInt(privateKeyInput.value);
        if (isNaN(d) || d < 1 || d >= p) {
            publicKeyDiv.innerHTML = `<span style="color: var(--error);">–û—à–∏–±–∫–∞: d –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 1..${p - 1}.</span>`;
            if (user === 'A') P_A = null; else P_B = null;
            return;
        }

        const P = multiplyPoint(d, G);

        if (user === 'A') {
            P_A = P;
            document.getElementById('ecdsaPublic').value = displayPoint(P); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è ECDSA
        } else {
            P_B = P;
        }

        publicKeyDiv.innerHTML = `
            1. –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á $d_${user}$ = ${d}
            2. –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_${user}$ = $d_${user} \cdot G$
            3. –†–µ–∑—É–ª—å—Ç–∞—Ç $P_${user}$ = ${displayPoint(P)}
        `;
        MathJax.typeset(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª MathJax
    }

    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞ K = d_A * P_B = d_B * P_A
    function calculateSharedSecret() {
        if (!P_A || !P_B) {
            document.getElementById('sharedSecret').innerHTML = `<span style="color: var(--error);">–û—à–∏–±–∫–∞: –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏ –ê–ª–∏—Å—ã –∏ –ë–æ–±–∞.</span>`;
            return;
        }

        const dA = parseInt(document.getElementById('alicePrivate').value);
        const dB = parseInt(document.getElementById('bobPrivate').value);

        // K_A = dA * P_B
        const KA = multiplyPoint(dA, P_B);
        // K_B = dB * P_A
        const KB = multiplyPoint(dB, P_A);

        let resultHTML;
        if (KA && KB && KA.x === KB.x && KA.y === KB.y) {
            resultHTML = `
                <span style="color: var(--success);">–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!</span><br>
                K_A = $d_A \cdot P_B$ = ${displayPoint(KA)}<br>
                K_B = $d_B \cdot P_A$ = ${displayPoint(KB)}<br>
                <strong>–û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç K: ${displayPoint(KA)}</strong>
            `;
        } else {
            resultHTML = `<span style="color: var(--error);">–û—à–∏–±–∫–∞: –û–±—â–∏–µ –∫–ª—é—á–∏ –Ω–µ —Å–æ–≤–ø–∞–ª–∏.</span>`;
        }

        document.getElementById('sharedSecret').innerHTML = resultHTML;
        MathJax.typeset();
    }

    // --- ECDSA –§–£–ù–ö–¶–ò–ò ---

    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è demo)
    function simpleHash(msg) {
        let hash = 0;
        for (let i = 0; i < msg.length; i++) {
            hash = (hash + msg.charCodeAt(i)) % (p - 1);
        }
        // –•—ç—à –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º, –º–µ–Ω—å—à–∏–º –ø–æ—Ä—è–¥–∫–∞ –∫—Ä–∏–≤–æ–π (1..16).
        return hash + 1;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏
    function generateSignature() {
        const d = parseInt(document.getElementById('ecdsaPrivate').value);
        const msg = document.getElementById('message').value;
        const resultDiv = document.getElementById('signatureResult');

        if (isNaN(d) || d < 1 || d >= p) {
            resultDiv.innerHTML = `<span style="color: var(--error);">–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á.</span>`;
            return;
        }

        // 1. –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ k (nonce). –ë–µ—Ä–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ k=3 –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞.
        const k = 3;
        const k_inv = inverse(k, p);

        // 2. –í—ã—á–∏—Å–ª—è–µ–º R = k * G
        const R_point = multiplyPoint(k, G);
        const r = mod(R_point.x, p);

        // 3. –í—ã—á–∏—Å–ª—è–µ–º e (—Ö—ç—à —Å–æ–æ–±—â–µ–Ω–∏—è)
        const e = simpleHash(msg);

        // 4. –í—ã—á–∏—Å–ª—è–µ–º s = k^-1 * (e + r * d) mod p
        const s_numerator = mod(e + r * d, p);
        const s = mod(k_inv * s_numerator, p);

        if (r === 0 || s === 0) {
            resultDiv.innerHTML = `<span style="color: var(--error);">–û—à–∏–±–∫–∞: r –∏–ª–∏ s —Ä–∞–≤–Ω–æ –Ω—É–ª—é. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Å –¥—Ä—É–≥–∏–º k (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏).</span>`;
            return;
        }

        document.getElementById('verifyR').value = r;
        document.getElementById('verifyS').value = s;

        resultDiv.className = "result-box success";
        resultDiv.innerHTML = `
            ‚úÖ –ü–æ–¥–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞.<br>
            d (–ü—Ä–∏–≤–∞—Ç–Ω—ã–π): ${d}<br>
            e (–•—ç—à): ${e}<br>
            k (Nonce): ${k}<br>
            R = kG: ${displayPoint(R_point)}<br>
            –ü–æ–¥–ø–∏—Å—å (r, s): <strong>(${r}, ${s})</strong>
        `;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
    function verifySignature() {
        const PA_input = document.getElementById('ecdsaPublic').value;
        const r = parseInt(document.getElementById('verifyR').value);
        const s = parseInt(document.getElementById('verifyS').value);
        const msg = document.getElementById('message').value;
        const resultDiv = document.getElementById('verificationResult');

        if (!PA_input || isNaN(r) || isNaN(s) || r < 1 || s < 1) {
            resultDiv.className = "result-box error";
            resultDiv.innerHTML = "‚ùå –û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (–ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á, r, s).";
            return;
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ P_A(x, y)
        const match = PA_input.match(/\((\d+),\s*(\d+)\)/);
        if (!match) {
             resultDiv.className = "result-box error";
             resultDiv.innerHTML = "‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ P_A.";
             return;
        }
        const P_A_verify = { x: parseInt(match[1]), y: parseInt(match[2]) };

        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ r, s –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [1, p-1]
        if (r < 1 || r >= p || s < 1 || s >= p) {
            resultDiv.className = "result-box error";
            resultDiv.innerHTML = "‚ùå –ü–æ–¥–ø–∏—Å—å –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞: r –∏–ª–∏ s –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞.";
            return;
        }

        // 2. –í—ã—á–∏—Å–ª—è–µ–º e (—Ö—ç—à —Å–æ–æ–±—â–µ–Ω–∏—è)
        const e = simpleHash(msg);

        // 3. –í—ã—á–∏—Å–ª—è–µ–º w = s^-1 mod p
        const w = inverse(s, p);

        // 4. –í—ã—á–∏—Å–ª—è–µ–º u1 = e * w mod p
        const u1 = mod(e * w, p);

        // 5. –í—ã—á–∏—Å–ª—è–µ–º u2 = r * w mod p
        const u2 = mod(r * w, p);

        // 6. –í—ã—á–∏—Å–ª—è–µ–º —Ç–æ—á–∫—É X = u1*G + u2*P_A
        const u1G = multiplyPoint(u1, G);
        const u2PA = multiplyPoint(u2, P_A_verify);
        const X = addPoints(u1G, u2PA);

        // 7. –ü—Ä–æ–≤–µ—Ä–∫–∞: v = X.x mod p. –ï—Å–ª–∏ v == r, –ø–æ–¥–ø–∏—Å—å –≤–µ—Ä–Ω–∞.
        const v = mod(X.x, p);

        let verificationMsg;
        if (v === r) {
            resultDiv.className = "result-box success";
            verificationMsg = "‚úÖ –ü–û–î–ü–ò–°–¨ –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–ê (r == v)";
        } else {
            resultDiv.className = "result-box error";
            verificationMsg = "‚ùå –ü–û–î–ü–ò–°–¨ –ù–ï–í–ï–†–ù–ê (r != v)";
        }

        resultDiv.innerHTML = `
            ${verificationMsg}<br>
            e (–•—ç—à): ${e}<br>
            w (s^-1): ${w}<br>
            u1*G: ${displayPoint(u1G)}<br>
            u2*PA: ${displayPoint(u2PA)}<br>
            v (X.x): ${v}, r (–ü–æ–¥–ø–∏—Å—å): ${r}
        `;
        MathJax.typeset();
    }
</script>
{% endblock %}
