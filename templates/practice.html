{% extends "base.html" %}

{% block title %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è: ECDH –∏ ECDSA{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 60px;">
    <h1>üß™ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</h1>
    <p style="font-size: 1.3rem; color: #aaa;">
        –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –∫—Ä–∏–≤—ã—Ö –∏ —Å–∏–º—É–ª—è—Ü–∏–∏ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤.
    </p>
</div>

<!-- 1. –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –•–û–õ–°–¢ -->
<div class="card" style="border-left-color: var(--accent-flower); margin-bottom: 40px;">
    <h2>1. –ì–µ–æ–º–µ—Ç—Ä–∏—è —Å–ª–æ–∂–µ–Ω–∏—è —Ç–æ—á–µ–∫ (P + Q)</h2>
    <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–∏–≤—É—é, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å $P$, –∑–∞—Ç–µ–º $Q$. –¢—Ä–µ—Ç—å—è —Ç–æ—á–∫–∞ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏.</p>
    
    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin: 20px 0;">
        <div style="flex: 1;">
            <label style="color: var(--accent-flower);">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç a: <span id="valA"></span></label>
            <input type="range" id="paramA" min="-7" max="5" step="0.1" value="-3" style="width: 100%;">
        </div>
        <div style="flex: 1;">
            <label style="color: var(--accent-flower);">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç b: <span id="valB"></span></label>
            <input type="range" id="paramB" min="-5" max="7" step="0.1" value="3" style="width: 100%;">
        </div>
    </div>

    <div style="position: relative;">
        <canvas id="eccCanvas" width="800" height="500" style="width: 100%; border: 1px solid #334155; background: #0f172a; cursor: crosshair; border-radius: 8px;"></canvas>
        <div id="statusOverlay" style="position: absolute; top: 10px; left: 10px; background: rgba(15, 23, 42, 0.8); padding: 5px 15px; border-radius: 4px; pointer-events: none; border: 1px solid #334155;">
            <span id="statusMsg" style="color: #38bdf8;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É P</span>
        </div>
    </div>

    <div class="interactive-panel" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div style="font-family: monospace; font-size: 1.1rem;">
            P: <span id="pointP" style="color: var(--accent-flower);">(?, ?)</span> |
            Q: <span id="pointQ" style="color: var(--accent-leaf);">(?, ?)</span> |
            <span style="border-left: 2px solid #475569; margin-left: 10px; padding-left: 10px;">
                R: <span id="pointR" style="color: #f87171;">(?, ?)</span>
            </span>
        </div>
        <button onclick="resetCanvas()" class="btn" style="background: #ef4444; color: white;">–°–±—Ä–æ—Å</button>
    </div>
</div>

<!-- 2. –°–ò–ú–£–õ–Ø–¢–û–† ECDH -->
<div class="card" style="border-left-color: var(--accent-leaf); margin-bottom: 40px;">
    <h2>2. ECDH: –û–±–º–µ–Ω –ö–ª—é—á–∞–º–∏ –î–∏—Ñ—Ñ–∏-–•–µ–ª–ª–º–∞–Ω–∞ –Ω–∞ –≠–ö</h2>
    <p>–ü—Ä–æ—Ç–æ–∫–æ–ª, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –ê–ª–∏—Å–µ –∏ –ë–æ–±—É —Å–æ–∑–¥–∞—Ç—å –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –ø–æ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –∫–∞–Ω–∞–ª—É.</p>
    <div class="math-block" style="margin-top: 10px; margin-bottom: 10px; text-align: center;">
        $$\text{–û–±—â–∏–π –∫–ª—é—á} = \text{–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –ê–ª–∏—Å—ã} \cdot \text{–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ë–æ–±–∞}$$
        <br>
        $$\text{–û–±—â–∏–π –∫–ª—é—á} = \text{–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –ë–æ–±–∞} \cdot \text{–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –ê–ª–∏—Å—ã}$$
    </div>
    <p style="color: var(--accent-flower);">* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è –∫—Ä–∏–≤–∞—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏: $y^2 = x^3 + 2x + 1 \pmod{17}$. –ë–∞–∑–æ–≤–∞—è —Ç–æ—á–∫–∞ $G(5, 1)$</p>

    <div class="interactive-panel" style="margin-top: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- –ê–ª–∏—Å–∞ -->
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                <h3>–ê–ª–∏—Å–∞ (Alice)</h3>
                <div class="input-group">
                    <label for="alicePrivate">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á $d_A$ (—á–∏—Å–ª–æ 1..16):</label>
                    <input type="number" id="alicePrivate" value="10" min="1" max="16" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #0f172a; color: white; border: 1px solid #334155;">
                    <button onclick="generateKeys('A')" class="btn" style="background: var(--accent-flower); width: 100%;">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
                </div>
                <div class="result-box" id="alicePublic" style="margin-top:10px; color: #94a3b8;">–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_A$: ?</div>
            </div>
            <!-- –ë–æ–± -->
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                <h3>–ë–æ–± (Bob)</h3>
                <div class="input-group">
                    <label for="bobPrivate">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á $d_B$ (—á–∏—Å–ª–æ 1..16):</label>
                    <input type="number" id="bobPrivate" value="7" min="1" max="16" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #0f172a; color: white; border: 1px solid #334155;">
                    <button onclick="generateKeys('B')" class="btn" style="background: var(--accent-flower); width: 100%;">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
                </div>
                <div class="result-box" id="bobPublic" style="margin-top:10px; color: #94a3b8;">–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_B$: ?</div>
            </div>
        </div>

        <button onclick="calculateSharedSecret()" class="btn" style="width: 100%; margin-top: 20px; background: #22c55e; color: white;">
            4. –í—ã—á–∏—Å–ª–∏—Ç—å –û–±—â–∏–π –°–µ–∫—Ä–µ—Ç (K)
        </button>
        <div class="result-box success" id="sharedSecret" style="margin-top:15px; font-weight: bold; text-align: center; color: #38bdf8;"></div>
    </div>
</div>

<!-- 3. –°–ò–ú–£–õ–Ø–¢–û–† ECDSA -->
<div class="card" style="border-left-color: #f59e0b;">
    <h2>3. ECDSA: –¶–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å</h2>
    <p>–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—â–µ–µ –µ–≥–æ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å.</p>
    
    <div class="interactive-panel" style="margin-top: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ -->
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                <h3>–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ (–ê–ª–∏—Å–∞)</h3>
                <div class="input-group">
                     <label for="ecdsaPrivate">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á $d_A$ (1..16):</label>
                     <input type="number" id="ecdsaPrivate" value="10" min="1" max="16" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #0f172a; color: white; border: 1px solid #334155;">
                     <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ (Message):</label>
                     <textarea id="message" rows="2" style="width: 100%; padding: 8px; background: #0f172a; color: white; border: 1px solid #334155; border-radius: 6px; margin-bottom: 10px;">–¢–∞–π–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –¥–ª—è –ë–æ–±–∞.</textarea>
                     <button onclick="generateSignature()" class="btn" style="background: var(--accent-flower); width: 100%;">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å—å (r, s)</button>
                </div>
                <div class="result-box" id="signatureResult" style="margin-top:10px; color: #38bdf8;"></div>
            </div>
            <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ -->
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ (–ë–æ–±)</h3>
                <div class="input-group">
                    <label for="ecdsaPublic">–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_A$ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏):</label>
                    <input type="text" id="ecdsaPublic" placeholder="PA(x, y)" style="width: 100%; padding: 8px; background: #334155; color: #94a3b8; border: 1px solid #475569; margin-bottom: 10px;" readonly>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="verifyR" placeholder="r" style="flex: 1; padding: 8px; background: #0f172a; color: white; border: 1px solid #334155;">
                        <input type="text" id="verifyS" placeholder="s" style="flex: 1; padding: 8px; background: #0f172a; color: white; border: 1px solid #334155;">
                    </div>
                    <button onclick="verifySignature()" class="btn" style="background: var(--accent-leaf); width: 100%;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å</button>
                </div>
                <div class="result-box" id="verificationResult" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- –ü–ê–†–ê–ú–ï–¢–†–´ –ö–†–ò–í–û–ô –î–õ–Ø ECDH/ECDSA ---
    const p = 17;     // –ú–æ–¥—É–ª—å –ø–æ–ª—è
    const n = 19;     // –ü–æ—Ä—è–¥–æ–∫ –≥—Ä—É–ø–ø—ã –¥–ª—è y^2 = x^3 + 2x + 2
    const G = { x: 5, y: 1 };
    const A_param = 2;
    const B_param = 2;

    function mod(n, m) { return ((n % m) + m) % m; }

    function inverse(a, m) {
        a = mod(a, m);
        for (let x = 1; x < m; x++) {
            if (mod(a * x, m) === 1) return x;
        }
        return 1;
    }

    function addPoints(P, Q) {
        if (!P) return Q;
        if (!Q) return P;
        let m;
        if (P.x === Q.x && mod(P.y + Q.y, p) === 0) return null;
        if (P.x === Q.x && P.y === Q.y) {
            m = mod((3 * P.x * P.x + A_param) * inverse(2 * P.y, p), p);
        } else {
            m = mod((Q.y - P.y) * inverse(Q.x - P.x, p), p);
        }
        const Rx = mod(m * m - P.x - Q.x, p);
        const Ry = mod(m * (P.x - Rx) - P.y, p);
        return { x: Rx, y: Ry };
    }

    function multiplyPoint(k, P) {
        let result = null;
        let current = P;
        let k_mod = mod(k, n); // –°–∫–∞–ª—è—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥—É—Ç –ø–æ –º–æ–¥—É–ª—é –ø–æ—Ä—è–¥–∫–∞ n
        while (k_mod > 0) {
            if (k_mod % 2 === 1) result = addPoints(result, current);
            current = addPoints(current, current);
            k_mod = Math.floor(k_mod / 2);
        }
        return result;
    }

    // --- –ì–†–ê–§–ò–ö ---
    const canvas = document.getElementById('eccCanvas');
    const ctx = canvas.getContext('2d');
    const SCALE = 50; 
    let A = -3, B = 3;
    let pointP = null, pointQ = null;

    function toCanvas(x, y) {
        return {
            x: canvas.width / 2 + x * SCALE,
            y: canvas.height / 2 - y * SCALE
        };
    }

    function toMath(cx, cy) {
        return {
            x: (cx - canvas.width / 2) / SCALE,
            y: (canvas.height / 2 - cy) / SCALE
        };
    }

    function drawGrid() {
        ctx.strokeStyle = "#1e293b";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let x = 0; x <= canvas.width; x += SCALE) { ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); }
        for(let y = 0; y <= canvas.height; y += SCALE) { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); }
        ctx.stroke();

        ctx.strokeStyle = "#334155";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height);
        ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2);
        ctx.stroke();
    }

    function drawCurve() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGrid();

        ctx.strokeStyle = "#38bdf8";
        ctx.lineWidth = 3;
        
        // –†–∏—Å—É–µ–º –µ–¥–∏–Ω—ã–º –∫–æ–Ω—Ç—É—Ä–æ–º –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ
        ctx.beginPath();
        let points = [];
        
        // –°–∫–∞–Ω–∏—Ä—É–µ–º X —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
        for (let i = 0; i < canvas.width; i++) {
            let x = (i - canvas.width/2) / SCALE;
            let rhs = x*x*x + A*x + B;
            if (rhs >= 0) {
                let y = Math.sqrt(rhs);
                points.push({x: i, y: canvas.height/2 - y * SCALE});
            }
        }
        
        // –†–∏—Å—É–µ–º –≤–µ—Ä—Ö–Ω—é—é —á–∞—Å—Ç—å
        if(points.length > 0) ctx.moveTo(points[0].x, points[0].y);
        for(let p of points) ctx.lineTo(p.x, p.y);
        
        // –†–∏—Å—É–µ–º –Ω–∏–∂–Ω—é—é —á–∞—Å—Ç—å –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –¥–ª—è –∑–∞–º—ã–∫–∞–Ω–∏—è –≤ —Ç–æ—á–∫–µ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞
        for(let i = points.length - 1; i >= 0; i--) {
            let x = (points[i].x - canvas.width/2) / SCALE;
            let rhs = x*x*x + A*x + B;
            ctx.lineTo(points[i].x, canvas.height/2 + Math.sqrt(rhs) * SCALE);
        }
        ctx.stroke();

        if (pointP && pointQ) drawAddition();
        if (pointP) drawPoint(pointP, "#a855f7", "P");
        if (pointQ) drawPoint(pointQ, "#22c55e", "Q");
    }

    function drawAddition() {
        let m, rx, ry;
        if (Math.abs(pointP.x - pointQ.x) < 0.0001) {
            if (Math.abs(pointP.y + pointQ.y) < 0.0001) return;
            m = (3 * pointP.x * pointP.x + A) / (2 * pointP.y);
        } else {
            m = (pointQ.y - pointP.y) / (pointQ.x - pointP.x);
        }

        rx = m * m - pointP.x - pointQ.x;
        ry = m * (pointP.x - rx) - pointP.y;

        ctx.setLineDash([5, 5]);
        ctx.strokeStyle = "rgba(255, 255, 255, 0.4)";
        ctx.beginPath();
        let xStart = -20, xEnd = 20;
        let pStart = toCanvas(xStart, pointP.y + m * (xStart - pointP.x));
        let pEnd = toCanvas(xEnd, pointP.y + m * (xEnd - pointP.x));
        ctx.moveTo(pStart.x, pStart.y);
        ctx.lineTo(pEnd.x, pEnd.y);
        ctx.stroke();

        const cR_mirror = toCanvas(rx, -ry);
        const cR_final = toCanvas(rx, ry);
        ctx.strokeStyle = "#f87171";
        ctx.beginPath();
        ctx.moveTo(cR_mirror.x, cR_mirror.y);
        ctx.lineTo(cR_final.x, cR_final.y);
        ctx.stroke();
        ctx.setLineDash([]);

        drawPoint({x: rx, y: -ry}, "#94a3b8", "R'");
        drawPoint({x: rx, y: ry}, "#f87171", "R");
        document.getElementById('pointR').innerText = `(${rx.toFixed(2)}, ${ry.toFixed(2)})`;
    }

    function drawPoint(p, color, label) {
        const c = toCanvas(p.x, p.y);
        ctx.fillStyle = color;
        ctx.shadowBlur = 10;
        ctx.shadowColor = color;
        ctx.beginPath();
        ctx.arc(c.x, c.y, 6, 0, Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = "white";
        ctx.font = "bold 14px Arial";
        ctx.fillText(label, c.x + 10, c.y - 10);
    }

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouse = toMath(e.clientX - rect.left, e.clientY - rect.top);
        
        let bestPoint = null, minDist = 0.5;
        // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–∏–∫—Ä–æ-—à–∞–≥–æ–º –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
        for(let x = mouse.x - 0.5; x <= mouse.x + 0.5; x += 0.001) {
            let rhs = x*x*x + A*x + B;
            if (rhs >= 0) {
                let yVal = Math.sqrt(rhs);
                [yVal, -yVal].forEach(curY => {
                    let d = Math.sqrt(Math.pow(x - mouse.x, 2) + Math.pow(curY - mouse.y, 2));
                    if (d < minDist) { minDist = d; bestPoint = {x, y: curY}; }
                });
            }
        }

        if (bestPoint) {
            if (!pointP) {
                pointP = bestPoint;
                document.getElementById('pointP').innerText = `(${bestPoint.x.toFixed(2)}, ${bestPoint.y.toFixed(2)})`;
                document.getElementById('statusMsg').innerText = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É Q";
            } else if (!pointQ) {
                pointQ = bestPoint;
                document.getElementById('pointQ').innerText = `(${bestPoint.x.toFixed(2)}, ${bestPoint.y.toFixed(2)})`;
                document.getElementById('statusMsg').innerText = "–ì–æ—Ç–æ–≤–æ!";
            }
            drawCurve();
        }
    });

    function resetCanvas() {
        pointP = null;
        pointQ = null;
        document.getElementById('pointP').innerText = "(?, ?)";
        document.getElementById('pointQ').innerText = "(?, ?)";
        document.getElementById('pointR').innerText = "(?, ?)";
        document.getElementById('statusMsg').innerText = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É P";
        drawCurve();
    }

    document.getElementById('paramA').oninput = (e) => { 
        A = parseFloat(e.target.value); 
        document.getElementById('valA').innerText = A; 
        resetCanvas(); 
    };
    document.getElementById('paramB').oninput = (e) => { 
        B = parseFloat(e.target.value); 
        document.getElementById('valB').innerText = B; 
        resetCanvas(); 
    };

    // --- ECDH –§–£–ù–ö–¶–ò–ò ---
    let P_A = null, P_B = null;

    function generateKeys(user) {
        const d = parseInt(document.getElementById(user === 'A' ? 'alicePrivate' : 'bobPrivate').value);
        const P = multiplyPoint(d, G);
        
        const displayPoint = P ? `(${P.x}, ${P.y})` : "O";

        if (user === 'A') {
            P_A = P;
            document.getElementById('alicePublic').innerText = `–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_A$: ${displayPoint}`;
            if(P) document.getElementById('ecdsaPublic').value = `(${P.x}, ${P.y})`;
            document.getElementById('ecdsaPrivate').value = d;
        } else {
            P_B = P;
            document.getElementById('bobPublic').innerText = `–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á $P_B$: ${displayPoint}`;
        }
        MathJax.typeset();
    }

    function calculateSharedSecret() {
        if (!P_A || !P_B) return alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –æ–±–∞ –∫–ª—é—á–∞!");
        const dA = parseInt(document.getElementById('alicePrivate').value);
        const secret = multiplyPoint(dA, P_B);
        const displaySecret = secret ? `(${secret.x}, ${secret.y})` : "O";
        document.getElementById('sharedSecret').innerHTML = `–û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç K: <b>${displaySecret}</b>`;
    }

    // --- ECDSA –§–£–ù–ö–¶–ò–ò ---
    function simpleHash(msg) {
        let hash = 0;
        for (let i = 0; i < msg.length; i++) hash = (hash + msg.charCodeAt(i)) % (n - 1);
        return hash + 1;
    }

    function generateSignature() {
        const d = parseInt(document.getElementById('ecdsaPrivate').value);
        if (!d) return alert("–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏ –ê–ª–∏—Å—ã –≤—ã—à–µ!");
        
        const msg = document.getElementById('message').value;
        const e = simpleHash(msg);
        const k = 3; 
        
        const R_point = multiplyPoint(k, G);
        const r = mod(R_point.x, n);
        const s = mod(inverse(k, n) * (e + r * d), n);

        document.getElementById('verifyR').value = r;
        document.getElementById('verifyS').value = s;
        document.getElementById('signatureResult').innerHTML = `‚úÖ –ü–æ–¥–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞: (r=${r}, s=${s})`;
    }

    function verifySignature() {
        const pubStr = document.getElementById('ecdsaPublic').value;
        const r = parseInt(document.getElementById('verifyR').value);
        const s = parseInt(document.getElementById('verifyS').value);
        const msg = document.getElementById('message').value;

        if (!pubStr.includes('(') || isNaN(r) || isNaN(s)) return alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏!");

        const coords = pubStr.match(/\d+/g);
        const PA = { x: parseInt(coords[0]), y: parseInt(coords[1]) };
        
        const e = simpleHash(msg);
        const w = inverse(s, n);
        const u1 = mod(e * w, n);
        const u2 = mod(r * w, n);
        
        const X = addPoints(multiplyPoint(u1, G), multiplyPoint(u2, PA));
        const resDiv = document.getElementById('verificationResult');

        if (X && mod(X.x, n) === r) {
            resDiv.innerHTML = "‚úÖ –ü–û–î–ü–ò–°–¨ –í–ï–†–ù–ê (r == v)";
            resDiv.className = "result-box success";
        } else {
            resDiv.innerHTML = "‚ùå –ü–û–î–ü–ò–°–¨ –ù–ï–í–ï–†–ù–ê";
            resDiv.className = "result-box error";
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = () => {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        drawCurve();
        
        document.getElementById('valA').innerText = A;
        document.getElementById('valB').innerText = B;
        
        document.getElementById('alicePriv').oninput = updateDH;
        document.getElementById('bobPriv').oninput = updateDH;
    };
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è ECDH
    function updateDH() {
        // –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    }
</script>
{% endblock %}
